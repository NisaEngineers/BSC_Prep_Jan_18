<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tempo ‚Äî Routine & Habit Tracker</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=Syne:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
:root {
  --bg: #0a0b0f;
  --surface: #111318;
  --surface2: #181b24;
  --surface3: #1e2130;
  --border: #272b3a;
  --border2: #323749;
  --text: #e8eaf2;
  --text2: #9198b0;
  --text3: #5a617a;
  --accent: #7c6af7;
  --accent2: #a89df8;
  --accent-glow: rgba(124,106,247,0.25);
  --green: #3ecf8e;
  --green-dim: rgba(62,207,142,0.15);
  --orange: #f7a35a;
  --orange-dim: rgba(247,163,90,0.15);
  --red: #f76a6a;
  --red-dim: rgba(247,106,106,0.15);
  --blue: #5a9ef7;
  --blue-dim: rgba(90,158,247,0.15);
  --purple: #b06af7;
  --cyan: #3ecff7;
  --gold: #f7d76a;
  --radius: 14px;
  --radius-sm: 8px;
  --font-head: 'Syne', sans-serif;
  --font-mono: 'DM Mono', monospace;
  --font-serif: 'DM Serif Display', serif;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 48px rgba(0,0,0,0.6);
}

*,*::before,*::after { box-sizing: border-box; margin:0; padding:0; }

html { font-size:15px; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-head);
  min-height: 100vh;
  overflow-x: hidden;
}

/* BACKGROUND GRID */
body::before {
  content:'';
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(124,106,247,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(124,106,247,0.03) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none;
  z-index: 0;
}

/* TOP NAV */
.topbar {
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: 100;
  display: flex;
  align-items: center;
  padding: 0 2rem;
  height: 60px;
  background: rgba(10,11,15,0.85);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
}
.logo {
  font-family: var(--font-serif);
  font-size: 1.6rem;
  color: var(--text);
  letter-spacing: -0.02em;
  display: flex;
  align-items: center;
  gap: 8px;
}
.logo-dot { color: var(--accent); }
.nav-tabs {
  display: flex;
  gap: 4px;
  margin: 0 auto;
}
.nav-tab {
  background: none;
  border: none;
  color: var(--text2);
  font-family: var(--font-head);
  font-size: 0.82rem;
  font-weight: 600;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  padding: 6px 16px;
  border-radius: 50px;
  cursor: pointer;
  transition: all 0.2s;
}
.nav-tab:hover { color: var(--text); background: var(--surface2); }
.nav-tab.active {
  color: var(--text);
  background: var(--surface3);
  box-shadow: inset 0 0 0 1px var(--border2);
}
.topbar-right {
  display: flex;
  align-items: center;
  gap: 12px;
}
.date-chip {
  font-family: var(--font-mono);
  font-size: 0.78rem;
  color: var(--text3);
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 4px 12px;
  border-radius: 50px;
}

/* MAIN */
.main {
  padding-top: 80px;
  min-height: 100vh;
  position: relative;
  z-index: 1;
}

.page { display: none; padding: 0 2rem 4rem; max-width: 1200px; margin: 0 auto; }
.page.active { display: block; animation: fadeUp 0.3s ease; }

@keyframes fadeUp {
  from { opacity:0; transform: translateY(8px); }
  to { opacity:1; transform: translateY(0); }
}

/* CARDS */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1.5rem;
}
.card-sm { padding: 1rem 1.25rem; }

/* HEADINGS */
.page-title {
  font-size: 2rem;
  font-weight: 800;
  letter-spacing: -0.03em;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 12px;
  color: var(--text);
}
.page-title .title-tag {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  font-weight: 400;
  color: var(--accent);
  background: var(--accent-glow);
  padding: 3px 10px;
  border-radius: 50px;
  border: 1px solid rgba(124,106,247,0.3);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  margin-top: 4px;
}

/* SECTION HEADERS */
.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1rem;
}
.section-title {
  font-size: 0.75rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text3);
}

/* INPUTS */
input, select, textarea {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: var(--font-head);
  font-size: 0.9rem;
  padding: 0.55rem 0.85rem;
  width: 100%;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}
input:focus, select:focus, textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}
textarea { resize: vertical; min-height: 60px; }
select { cursor: pointer; }
option { background: var(--surface2); }
input[type="date"], input[type="time"] {
  cursor: pointer;
  color-scheme: dark;
}
label {
  display: block;
  font-size: 0.75rem;
  font-weight: 600;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 0.35rem;
}

/* BUTTONS */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 0.5rem 1.1rem;
  border-radius: var(--radius-sm);
  border: none;
  cursor: pointer;
  font-family: var(--font-head);
  font-size: 0.85rem;
  font-weight: 700;
  letter-spacing: 0.02em;
  transition: all 0.15s;
  white-space: nowrap;
}
.btn-primary {
  background: var(--accent);
  color: #fff;
  box-shadow: 0 0 16px var(--accent-glow);
}
.btn-primary:hover { background: var(--accent2); transform: translateY(-1px); }
.btn-ghost {
  background: var(--surface2);
  color: var(--text2);
  border: 1px solid var(--border);
}
.btn-ghost:hover { background: var(--surface3); color: var(--text); }
.btn-danger {
  background: var(--red-dim);
  color: var(--red);
  border: 1px solid rgba(247,106,106,0.2);
}
.btn-danger:hover { background: rgba(247,106,106,0.25); }
.btn-green {
  background: var(--green-dim);
  color: var(--green);
  border: 1px solid rgba(62,207,142,0.2);
}
.btn-green:hover { background: rgba(62,207,142,0.25); }
.btn-sm { padding: 0.3rem 0.75rem; font-size: 0.78rem; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }

/* BADGES */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-family: var(--font-mono);
  font-size: 0.72rem;
  font-weight: 500;
  padding: 2px 9px;
  border-radius: 50px;
}
.badge-green { background: var(--green-dim); color: var(--green); border: 1px solid rgba(62,207,142,0.2); }
.badge-red { background: var(--red-dim); color: var(--red); border: 1px solid rgba(247,106,106,0.2); }
.badge-orange { background: var(--orange-dim); color: var(--orange); border: 1px solid rgba(247,163,90,0.2); }
.badge-blue { background: var(--blue-dim); color: var(--blue); border: 1px solid rgba(90,158,247,0.2); }
.badge-gray { background: var(--surface3); color: var(--text3); border: 1px solid var(--border); }
.badge-accent { background: var(--accent-glow); color: var(--accent2); border: 1px solid rgba(124,106,247,0.3); }

/* GRID LAYOUTS */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
.grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
.grid-sidebar { display: grid; grid-template-columns: 340px 1fr; gap: 1.5rem; align-items: start; }

/* PROGRESS BAR */
.progress-bar-wrap {
  width: 100%;
  height: 6px;
  background: var(--surface3);
  border-radius: 50px;
  overflow: hidden;
  margin-top: 6px;
}
.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  border-radius: 50px;
  transition: width 0.5s cubic-bezier(0.4,0,0.2,1);
}

/* METRIC CARDS */
.metric-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1.2rem 1.4rem;
}
.metric-label {
  font-size: 0.7rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 6px;
}
.metric-value {
  font-size: 2rem;
  font-weight: 800;
  letter-spacing: -0.04em;
  color: var(--text);
  line-height: 1;
}
.metric-sub {
  font-size: 0.75rem;
  color: var(--text3);
  margin-top: 4px;
  font-family: var(--font-mono);
}

/* TASK ITEMS */
.task-list { display: flex; flex-direction: column; gap: 8px; }

.task-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.task-item:hover { border-color: var(--border2); }
.task-item.completed-task { border-color: rgba(62,207,142,0.2); }
.task-item.missed-task { border-color: rgba(247,106,106,0.15); opacity: 0.7; }
.task-item.unassigned-task { border-color: rgba(90,158,247,0.2); }

.task-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 0.9rem 1.1rem;
  cursor: pointer;
  user-select: none;
}
.task-checkbox {
  width: 20px; height: 20px;
  min-width: 20px;
  border-radius: 6px;
  border: 2px solid var(--border2);
  background: none;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  transition: all 0.15s;
  font-size: 11px;
}
.task-checkbox.checked { background: var(--green); border-color: var(--green); color: #fff; }
.task-checkbox.missed { background: var(--surface3); border-color: var(--border); color: var(--text3); cursor: not-allowed; }

.task-name {
  font-size: 0.95rem;
  font-weight: 700;
  flex: 1;
}
.task-name.done { text-decoration: line-through; color: var(--text2); }
.task-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.task-body {
  display: none;
  padding: 0 1.1rem 1rem;
  border-top: 1px solid var(--border);
}
.task-body.open { display: block; animation: fadeUp 0.2s ease; }

.task-time-row {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 0.75rem;
  margin-bottom: 0.5rem;
}
.time-badge {
  font-family: var(--font-mono);
  font-size: 0.78rem;
  color: var(--text2);
  background: var(--surface2);
  border: 1px solid var(--border);
  padding: 3px 10px;
  border-radius: 50px;
  display: flex;
  align-items: center;
  gap: 5px;
}
.time-badge .arrow { color: var(--text3); }

/* INTERVAL EDITOR */
.interval-row {
  display: grid;
  grid-template-columns: 1fr 1fr auto auto;
  gap: 8px;
  align-items: end;
  margin-top: 8px;
  padding: 10px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
}
.interval-row input { font-family: var(--font-mono); }

/* TIMER WIDGET */
.timer-widget {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 0.9rem 1.1rem;
  margin-top: 10px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}
.timer-display {
  font-family: var(--font-mono);
  font-size: 1.5rem;
  font-weight: 500;
  color: var(--text);
  letter-spacing: 0.05em;
  min-width: 90px;
}
.timer-display.running { color: var(--green); }
.timer-display.paused { color: var(--orange); }

/* PULSING DOT - improved: only when running, CSS animation, no flicker */
.live-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--green);
  flex-shrink: 0;
  animation: pulse-dot 2s ease-in-out infinite;
}
@keyframes pulse-dot {
  0%, 100% { box-shadow: 0 0 0 0 rgba(62,207,142,0.5); opacity: 1; }
  50% { box-shadow: 0 0 0 5px rgba(62,207,142,0); opacity: 0.8; }
}

.timer-buttons { display: flex; gap: 6px; flex-wrap: wrap; }

/* UNASSIGNED TASKS PANEL */
.unassigned-tag {
  font-family: var(--font-mono);
  font-size: 0.68rem;
  color: var(--blue);
  background: var(--blue-dim);
  padding: 2px 8px;
  border-radius: 50px;
  border: 1px solid rgba(90,158,247,0.2);
}

/* CATEGORY COLORS */
.cat-Work { color: var(--blue); }
.cat-Sleep { color: var(--purple); }
.cat-Exercise { color: var(--green); }
.cat-Leisure { color: var(--orange); }
.cat-Study { color: var(--cyan); }
.cat-Other { color: var(--text2); }

/* TIMELINE */
.timeline-wrap {
  position: relative;
  overflow-x: auto;
  margin-top: 1rem;
}
.timeline-inner {
  min-width: 600px;
  position: relative;
  height: 60px;
  background: var(--surface2);
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
}
.timeline-block {
  position: absolute;
  top: 8px;
  height: 44px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.72rem;
  font-weight: 700;
  white-space: nowrap;
  overflow: hidden;
  padding: 0 6px;
  cursor: default;
  transition: opacity 0.2s;
  min-width: 4px;
}
.timeline-block:hover { opacity: 0.85; z-index: 2; }
.timeline-now {
  position: absolute;
  top: 0; bottom: 0;
  width: 2px;
  background: var(--red);
  border-radius: 2px;
  z-index: 3;
}
.timeline-now::before {
  content: '';
  position: absolute;
  top: -4px; left: -4px;
  width: 10px; height: 10px;
  background: var(--red);
  border-radius: 50%;
}
.timeline-labels {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  font-family: var(--font-mono);
  font-size: 0.65rem;
  color: var(--text3);
  min-width: 600px;
}

/* HABIT HEATMAP */
.heatmap-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 3px;
  margin-top: 8px;
}
.heatmap-cell {
  width: 16px; height: 16px;
  border-radius: 3px;
  cursor: default;
  transition: transform 0.1s;
}
.heatmap-cell:hover { transform: scale(1.2); }
.heatmap-cell[data-val="0"] { background: var(--surface3); }
.heatmap-cell[data-val="1"] { background: rgba(62,207,142,0.3); }
.heatmap-cell[data-val="2"] { background: rgba(62,207,142,0.6); }
.heatmap-cell[data-val="3"] { background: var(--green); }

/* STREAK */
.streak-row {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.82rem;
  color: var(--text2);
}
.streak-num {
  font-family: var(--font-mono);
  font-size: 1.1rem;
  font-weight: 500;
  color: var(--gold);
}

/* WEEK GRID */
.week-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  margin-top: 1rem;
}
.week-cell {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 0.9rem 0.7rem;
  text-align: center;
}
.week-cell.today { border-color: var(--accent); box-shadow: 0 0 12px var(--accent-glow); }
.week-day { font-size: 0.68rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text3); }
.week-date { font-size: 1.3rem; font-weight: 800; letter-spacing: -0.04em; margin: 4px 0; }
.week-bar {
  height: 4px;
  background: var(--surface3);
  border-radius: 50px;
  overflow: hidden;
  margin-top: 6px;
}
.week-bar-fill {
  height: 100%;
  border-radius: 50px;
  background: linear-gradient(90deg, var(--accent), var(--green));
}

/* ANALYTICS CHART WRAPPER */
.chart-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1.5rem;
}
.chart-card canvas { max-height: 260px; }

/* SCROLLBAR */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--surface); }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

/* MODAL */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(8px);
  z-index: 200;
  align-items: center;
  justify-content: center;
  padding: 1.5rem;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 20px;
  padding: 2rem;
  width: 100%;
  max-width: 480px;
  box-shadow: var(--shadow-lg);
  animation: modalIn 0.2s ease;
}
@keyframes modalIn {
  from { transform: scale(0.95); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
.modal-title {
  font-size: 1.35rem;
  font-weight: 800;
  letter-spacing: -0.03em;
  margin-bottom: 1.25rem;
  color: var(--text);
}
.modal-row { margin-bottom: 1rem; }
.modal-footer { display: flex; gap: 8px; margin-top: 1.5rem; justify-content: flex-end; }

/* TOAST */
.toast-container {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  z-index: 500;
  display: flex;
  flex-direction: column;
  gap: 8px;
  pointer-events: none;
}
.toast {
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: var(--radius-sm);
  padding: 0.7rem 1rem;
  font-size: 0.85rem;
  color: var(--text);
  box-shadow: var(--shadow);
  animation: toastIn 0.25s ease, toastOut 0.25s ease 2.5s forwards;
  pointer-events: auto;
  display: flex;
  align-items: center;
  gap: 8px;
  max-width: 300px;
}
@keyframes toastIn { from { transform: translateX(20px); opacity:0; } to { transform: translateX(0); opacity:1; } }
@keyframes toastOut { from { opacity:1; } to { opacity:0; pointer-events:none; } }

/* CHIP SELECTOR */
.chip-row { display: flex; flex-wrap: wrap; gap: 6px; }
.chip {
  border: 1px solid var(--border);
  background: var(--surface2);
  color: var(--text2);
  border-radius: 50px;
  padding: 4px 14px;
  font-size: 0.78rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
}
.chip:hover { background: var(--surface3); color: var(--text); }
.chip.selected {
  background: var(--accent-glow);
  border-color: var(--accent);
  color: var(--accent2);
}

/* EMPTY STATE */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 4rem 2rem;
  text-align: center;
  color: var(--text3);
}
.empty-icon { font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.4; }
.empty-msg { font-size: 1rem; font-weight: 600; }
.empty-sub { font-size: 0.82rem; margin-top: 4px; color: var(--text3); }

/* DIVIDER */
.divider { height: 1px; background: var(--border); margin: 1.25rem 0; }

/* INFO TEXT */
.info-text {
  font-size: 0.8rem;
  color: var(--text3);
  font-family: var(--font-mono);
  display: flex;
  align-items: center;
  gap: 6px;
}

/* STICKY DATE BAR */
.date-bar {
  position: sticky;
  top: 60px;
  z-index: 50;
  background: rgba(10,11,15,0.9);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  padding: 0.75rem 2rem;
  margin: 0 -2rem;
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 1.5rem;
}
.date-nav-btn {
  width: 30px; height: 30px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--surface2);
  color: var(--text2);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.9rem;
  transition: all 0.15s;
}
.date-nav-btn:hover { border-color: var(--border2); color: var(--text); }
.date-display {
  font-size: 1rem;
  font-weight: 700;
  letter-spacing: -0.01em;
  min-width: 160px;
}
.today-btn {
  font-size: 0.72rem;
  font-weight: 700;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--accent);
  cursor: pointer;
  border: 1px solid rgba(124,106,247,0.3);
  background: var(--accent-glow);
  padding: 3px 10px;
  border-radius: 50px;
  transition: all 0.15s;
}
.today-btn:hover { background: rgba(124,106,247,0.3); }
.date-input-hidden { display: none; }

/* Quick filter tabs */
.filter-row {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 1rem;
}

@media (max-width: 768px) {
  .grid-sidebar { grid-template-columns: 1fr; }
  .grid-4 { grid-template-columns: 1fr 1fr; }
  .grid-3 { grid-template-columns: 1fr; }
  .week-grid { grid-template-columns: repeat(4, 1fr); }
  .nav-tab span { display: none; }
  .topbar-right .date-chip { display: none; }
}
</style>
</head>
<body>

<!-- TOP NAV -->
<div class="topbar">
  <div class="logo">Tempo<span class="logo-dot">.</span></div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchTab('daily')">üìã <span>Daily</span></button>
    <button class="nav-tab" onclick="switchTab('habits')">üî• <span>Habits</span></button>
    <button class="nav-tab" onclick="switchTab('weekly')">üìÜ <span>Weekly</span></button>
    <button class="nav-tab" onclick="switchTab('analytics')">üìä <span>Analytics</span></button>
  </div>
  <div class="topbar-right">
    <div class="date-chip" id="liveClock">--:--:--</div>
    <div class="date-chip" id="fileSaveIndicator" style="cursor:pointer" onclick="openDataPanel()" title="Data &amp; File Settings">
      <span style="color:var(--text3)">‚óã No file</span>
    </div>
    <button class="btn btn-ghost btn-sm" onclick="openDataPanel()" title="Data &amp; backup">üíæ</button>
    <button class="btn btn-primary btn-sm" onclick="openAddModal()">+ Task</button>
  </div>
</div>

<!-- Hidden file input for import fallback -->
<input type="file" id="importFileInput" accept=".json" style="display:none" onchange="importFromInput(this)"/>

<!-- MAIN -->
<div class="main">

  <!-- ======================== DAILY PAGE ======================== -->
  <div class="page active" id="page-daily">
    <!-- Sticky Date Bar -->
    <div class="date-bar">
      <button class="date-nav-btn" onclick="shiftDay(-1)">‚Äπ</button>
      <div class="date-display" id="selectedDateDisplay">Today</div>
      <button class="date-nav-btn" onclick="shiftDay(1)">‚Ä∫</button>
      <input type="date" id="datePickerHidden" class="date-input-hidden" onchange="onDatePickerChange(this.value)"/>
      <button class="date-nav-btn" onclick="document.getElementById('datePickerHidden').showPicker()" title="Pick date">üìÖ</button>
      <button class="today-btn" onclick="goToday()">Today</button>
      <div style="flex:1"></div>
      <div id="dayProgress" style="font-family:var(--font-mono);font-size:0.78rem;color:var(--text3)"></div>
    </div>

    <!-- Metrics Row -->
    <div class="grid-4" id="dailyMetrics" style="margin-bottom:1.5rem"></div>

    <!-- Timeline -->
    <div class="card" style="margin-bottom:1.5rem">
      <div class="section-header">
        <span class="section-title">üïê Timeline</span>
        <span class="info-text" id="timelineInfo"></span>
      </div>
      <div class="timeline-wrap">
        <div class="timeline-inner" id="timelineTrack"></div>
        <div class="timeline-labels" id="timelineLabels"></div>
      </div>
    </div>

    <!-- Filter Row -->
    <div class="filter-row" id="filterRow"></div>

    <!-- Tasks -->
    <div class="task-list" id="taskList">
      <div class="empty-state">
        <div class="empty-icon">‚ú¶</div>
        <div class="empty-msg">No tasks yet</div>
        <div class="empty-sub">Press <strong>+ Task</strong> to add one</div>
      </div>
    </div>
  </div>

  <!-- ======================== HABITS PAGE ======================== -->
  <div class="page" id="page-habits">
    <div class="page-title">Habit Tracker <span class="title-tag">Build streaks</span></div>
    <div class="grid-sidebar">
      <div>
        <div class="card">
          <p style="font-size:.85rem;font-weight:700;margin-bottom:1rem;">Add New Habit</p>
          <div class="modal-row">
            <label>Habit Name</label>
            <input type="text" id="habitNameInput" placeholder="e.g. Drink 2L water"/>
          </div>
          <div class="modal-row">
            <label>Frequency</label>
            <select id="habitFreq">
              <option>Daily</option>
              <option>Weekly</option>
              <option>Custom (times per week)</option>
            </select>
          </div>
          <div id="habitTargetRow" class="modal-row" style="display:none">
            <label>Times per week</label>
            <input type="number" id="habitTarget" value="3" min="1" max="7"/>
          </div>
          <div class="modal-row">
            <label>Color Tag</label>
            <div class="chip-row" id="habitColorPicker"></div>
          </div>
          <div class="modal-row">
            <label>Notes / Reminder</label>
            <textarea id="habitNotes" placeholder="Optional reminder..." rows="2"></textarea>
          </div>
          <button class="btn btn-primary" style="width:100%" onclick="addHabit()">Add Habit</button>
        </div>
      </div>
      <div>
        <div id="habitList"></div>
      </div>
    </div>
  </div>

  <!-- ======================== WEEKLY PAGE ======================== -->
  <div class="page" id="page-weekly">
    <div class="page-title">Weekly Overview <span class="title-tag">This week</span></div>
    <div class="week-grid" id="weekGrid" style="margin-bottom:2rem"></div>
    <div class="chart-card" style="margin-bottom:1.5rem">
      <p style="font-size:.82rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--text3);margin-bottom:1rem">Planned vs Tracked Hours</p>
      <canvas id="weeklyChart"></canvas>
    </div>
    <div id="weeklyDetails"></div>
  </div>

  <!-- ======================== ANALYTICS PAGE ======================== -->
  <div class="page" id="page-analytics">
    <div class="page-title">Analytics <span class="title-tag">Insights</span></div>
    <div class="grid-3" id="analyticsMetrics" style="margin-bottom:1.5rem"></div>
    <div class="grid-2" style="margin-bottom:1.5rem">
      <div class="chart-card">
        <p style="font-size:.82rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--text3);margin-bottom:1rem">Time by Category</p>
        <canvas id="catChart"></canvas>
      </div>
      <div class="chart-card">
        <p style="font-size:.82rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--text3);margin-bottom:1rem">Daily Time Trend</p>
        <canvas id="trendChart"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <p style="font-size:.82rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--text3);margin-bottom:1rem">Completion Rate Over Time</p>
      <canvas id="completionChart"></canvas>
    </div>
  </div>

</div><!-- end main -->

<!-- ADD TASK MODAL -->
<div class="modal-overlay" id="addModal" onclick="closeModalIfOverlay(event)">
  <div class="modal">
    <div class="modal-title">New Task</div>
    <div class="modal-row">
      <label>Task Name *</label>
      <input type="text" id="newTaskName" placeholder="e.g. Deep work session" onkeydown="if(event.key==='Enter')submitAddTask()"/>
    </div>
    <div class="modal-row">
      <label>Category</label>
      <div class="chip-row" id="catPicker"></div>
    </div>
    <div class="modal-row">
      <label>Schedule</label>
      <div class="chip-row" id="scheduleTypePicker">
        <div class="chip selected" data-sched="assign" onclick="setScheduleType('assign')">Assign Time</div>
        <div class="chip" data-sched="later" onclick="setScheduleType('later')">Assign Later</div>
      </div>
    </div>
    <div id="timeAssignSection" class="modal-row">
      <div class="grid-2">
        <div>
          <label>Start</label>
          <input type="time" id="newTaskStart"/>
        </div>
        <div>
          <label>End</label>
          <input type="time" id="newTaskEnd"/>
        </div>
      </div>
    </div>
    <div class="modal-row">
      <label>Notes</label>
      <textarea id="newTaskNotes" placeholder="Optional..." rows="2"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeAddModal()">Cancel</button>
      <button class="btn btn-primary" onclick="submitAddTask()">Add Task</button>
    </div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<!-- DATA PANEL MODAL -->
<div class="modal-overlay" id="dataModal" onclick="closeDataPanelIfOverlay(event)">
  <div class="modal" style="max-width:420px">
    <div class="modal-title">Data &amp; Storage</div>

    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:1rem;margin-bottom:1rem">
      <div style="font-size:.75rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text3);margin-bottom:.5rem">Working Directory File</div>
      <p style="font-size:.82rem;color:var(--text2);margin-bottom:.75rem;line-height:1.5">
        Link to a <code style="background:var(--surface3);padding:1px 5px;border-radius:4px;font-family:var(--font-mono);font-size:.8rem">routine_state.json</code> file on disk. Once linked, every change auto-saves to that file in real time.
      </p>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-primary btn-sm" onclick="linkFile()">Link / Create File</button>
        <button class="btn btn-ghost btn-sm" onclick="openFromFile()">Open Existing File</button>
      </div>
      <div style="margin-top:.65rem;font-family:var(--font-mono);font-size:.75rem" id="dataModalFileStatus"></div>
    </div>

    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:1rem;margin-bottom:1rem">
      <div style="font-size:.75rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text3);margin-bottom:.5rem">Backup and Restore</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-ghost btn-sm" onclick="exportData()">Download Backup</button>
        <button class="btn btn-ghost btn-sm" onclick="document.getElementById('importFileInput').click()">Import Backup</button>
      </div>
    </div>

    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:1rem;margin-bottom:1rem">
      <div style="font-size:.75rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text3);margin-bottom:.5rem">Storage Info</div>
      <div id="storageStats" style="font-family:var(--font-mono);font-size:.78rem;color:var(--text2);line-height:1.8"></div>
    </div>

    <details style="margin-bottom:1rem">
      <summary style="font-size:.75rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--red);cursor:pointer;padding:.5rem 0">Danger Zone</summary>
      <div style="margin-top:.75rem;padding:.75rem;background:var(--red-dim);border:1px solid rgba(247,106,106,0.2);border-radius:var(--radius-sm)">
        <p style="font-size:.8rem;color:var(--text2);margin-bottom:.75rem">Permanently delete all routines and habits from localStorage. Linked file is not affected.</p>
        <button class="btn btn-danger btn-sm" onclick="clearAllData()">Clear All Local Data</button>
      </div>
    </details>

    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeDataPanel()">Close</button>
    </div>
  </div>
</div>

<script>
// =============================================
// DATA LAYER ‚Äî localStorage + File System Access API
// =============================================
const STORAGE_KEY = 'tempo_v2';
const FILE_NAME = 'routine_state.json';

// In-memory file handle (persisted via IndexedDB for page reloads)
let _fileHandle = null;

// ‚îÄ‚îÄ IndexedDB handle persistence ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const IDB_NAME = 'tempo_fsa', IDB_STORE = 'handles', IDB_KEY = 'mainFile';

function idbOpen() {
  return new Promise((res, rej) => {
    const req = indexedDB.open(IDB_NAME, 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore(IDB_STORE);
    req.onsuccess = e => res(e.target.result);
    req.onerror = e => rej(e);
  });
}

async function idbSaveHandle(handle) {
  try {
    const db = await idbOpen();
    const tx = db.transaction(IDB_STORE, 'readwrite');
    tx.objectStore(IDB_STORE).put(handle, IDB_KEY);
  } catch(e) {}
}

async function idbLoadHandle() {
  try {
    const db = await idbOpen();
    return new Promise((res) => {
      const tx = db.transaction(IDB_STORE, 'readonly');
      const req = tx.objectStore(IDB_STORE).get(IDB_KEY);
      req.onsuccess = e => res(e.target.result || null);
      req.onerror = () => res(null);
    });
  } catch(e) { return null; }
}

// ‚îÄ‚îÄ Core save/load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadData() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return { routines: {}, habits: {} };
    return JSON.parse(raw);
  } catch(e) { return { routines: {}, habits: {} }; }
}

async function saveData(d) {
  // Always save to localStorage as the fast/reliable primary
  localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
  // Also write to file if we have a handle
  if (_fileHandle) {
    try {
      const writable = await _fileHandle.createWritable();
      await writable.write(JSON.stringify(d, null, 2));
      await writable.close();
      updateFileSaveIndicator(true);
    } catch(e) {
      // Handle may have lost permission ‚Äî clear it
      _fileHandle = null;
      updateFileSaveIndicator(false);
    }
  }
}

function updateFileSaveIndicator(connected) {
  const el = document.getElementById('fileSaveIndicator');
  if (!el) return;
  if (connected) {
    el.innerHTML = `<span style="color:var(--green)">‚óè File linked</span>`;
    el.title = 'Auto-saving to ' + FILE_NAME;
  } else {
    el.innerHTML = `<span style="color:var(--text3)">‚óã No file</span>`;
    el.title = 'Click "Link File" to auto-save to disk';
  }
}

// ‚îÄ‚îÄ File System Access API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FS_OPTS = {
  types: [{ description: 'JSON Data', accept: { 'application/json': ['.json'] } }],
  suggestedName: FILE_NAME
};

async function linkFile() {
  if (!window.showSaveFilePicker) {
    toast('File System API not supported in this browser. Use Export/Import instead.', '‚ö†');
    return;
  }
  try {
    const handle = await window.showSaveFilePicker(FS_OPTS);
    _fileHandle = handle;
    await idbSaveHandle(handle);
    // Write current data immediately
    const writable = await handle.createWritable();
    await writable.write(JSON.stringify(appData, null, 2));
    await writable.close();
    updateFileSaveIndicator(true);
    toast(`Linked to "${handle.name}" ‚Äî auto-saving on every change`, 'üíæ');
  } catch(e) {
    if (e.name !== 'AbortError') toast('Could not link file: ' + e.message, '‚úï');
  }
}

async function openFromFile() {
  if (!window.showOpenFilePicker) {
    // Fallback to input
    document.getElementById('importFileInput').click();
    return;
  }
  try {
    const [handle] = await window.showOpenFilePicker({
      types: [{ description: 'JSON Data', accept: { 'application/json': ['.json'] } }]
    });
    _fileHandle = handle;
    await idbSaveHandle(handle);
    const file = await handle.getFile();
    const text = await file.text();
    const parsed = JSON.parse(text);
    if (!parsed.routines) throw new Error('Invalid file format');
    appData = parsed;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
    updateFileSaveIndicator(true);
    toast(`Loaded from "${handle.name}"`, 'üìÇ');
    renderDaily();
  } catch(e) {
    if (e.name !== 'AbortError') toast('Could not open file: ' + e.message, '‚úï');
  }
}

// ‚îÄ‚îÄ Export (download) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportData() {
  const json = JSON.stringify(appData, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `tempo_backup_${todayStr()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast('Backup downloaded!', '‚¨á');
}

// ‚îÄ‚îÄ Import (file input fallback) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function importFromInput(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const parsed = JSON.parse(e.target.result);
      if (!parsed.routines) throw new Error('Invalid format');
      if (!confirm(`This will replace ALL current data with the imported file. Continue?`)) return;
      appData = parsed;
      saveData(appData);
      toast(`Imported "${file.name}" successfully`, 'üìÇ');
      renderDaily();
    } catch(err) {
      toast('Import failed: ' + err.message, '‚úï');
    }
    input.value = '';
  };
  reader.readAsText(file);
}

// ‚îÄ‚îÄ On load: try to restore previous file handle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function tryRestoreFileHandle() {
  const handle = await idbLoadHandle();
  if (!handle) return;
  try {
    // Check if we still have permission (may need user gesture to re-grant)
    const perm = await handle.queryPermission({ mode: 'readwrite' });
    if (perm === 'granted') {
      _fileHandle = handle;
      // Sync: read file, merge with localStorage (file wins if newer)
      const file = await handle.getFile();
      const text = await file.text();
      const fileData = JSON.parse(text);
      if (fileData && fileData.routines) {
        appData = fileData;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
      }
      updateFileSaveIndicator(true);
      toast(`Auto-linked to "${handle.name}"`, 'üíæ');
      renderDaily();
    } else {
      // Will need user gesture to re-request
      updateFileSaveIndicator(false);
    }
  } catch(e) {
    updateFileSaveIndicator(false);
  }
}

let appData = loadData();

function getOrCreateDay(dateStr) {
  if (!appData.routines[dateStr]) appData.routines[dateStr] = {};
  return appData.routines[dateStr];
}

// =============================================
// STATE
// =============================================
let selectedDate = todayStr();
let activeFilter = 'all';
let scheduleTypeMode = 'assign';
let selectedCat = 'Work';
let habitSelectedColor = '#7c6af7';
let runningTimers = {}; // { "dateStr|taskName": intervalId }
let weeklyChartInst = null;
let catChartInst = null;
let trendChartInst = null;
let completionChartInst = null;

// =============================================
// UTILS
// =============================================
function todayStr() {
  const d = new Date();
  return d.toISOString().slice(0, 10);
}

function formatDateDisplay(dateStr) {
  const d = new Date(dateStr + 'T00:00:00');
  const today = todayStr();
  const yesterday = shiftDateStr(today, -1);
  const tomorrow = shiftDateStr(today, 1);
  if (dateStr === today) return 'Today';
  if (dateStr === yesterday) return 'Yesterday';
  if (dateStr === tomorrow) return 'Tomorrow';
  return d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });
}

function shiftDateStr(dateStr, days) {
  const d = new Date(dateStr + 'T00:00:00');
  d.setDate(d.getDate() + days);
  return d.toISOString().slice(0, 10);
}

function parseMinutes(timeStr) {
  // "HH:MM" 24h
  const [h, m] = timeStr.split(':').map(Number);
  return h * 60 + m;
}

function minToTime(min) {
  const h = Math.floor(min / 60) % 24;
  const m = min % 60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}

function formatDuration(min) {
  if (min < 60) return `${min}m`;
  return `${Math.floor(min/60)}h ${min%60 > 0 ? (min%60)+'m' : ''}`.trim();
}

function formatTimer(sec) {
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = sec % 60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function nowMinutes() {
  const n = new Date();
  return n.getHours() * 60 + n.getMinutes();
}

function isToday(dateStr) { return dateStr === todayStr(); }
function isPast(dateStr) { return dateStr < todayStr(); }

const CAT_COLORS = {
  Work: '#5a9ef7',
  Sleep: '#b06af7',
  Exercise: '#3ecf8e',
  Leisure: '#f7a35a',
  Study: '#3ecff7',
  Other: '#9198b0'
};
const CATS = Object.keys(CAT_COLORS);

function catColor(c) { return CAT_COLORS[c] || '#9198b0'; }

// =============================================
// CLOCK
// =============================================
function updateClock() {
  const n = new Date();
  const s = n.toLocaleTimeString('en-US', { hour12: false });
  document.getElementById('liveClock').textContent = s;
}
setInterval(updateClock, 1000);
updateClock();

// =============================================
// NAVIGATION
// =============================================
function switchTab(tab) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + tab).classList.add('active');
  const idx = { daily: 0, habits: 1, weekly: 2, analytics: 3 }[tab];
  document.querySelectorAll('.nav-tab')[idx].classList.add('active');

  if (tab === 'habits') renderHabits();
  if (tab === 'weekly') renderWeekly();
  if (tab === 'analytics') renderAnalytics();
}

// =============================================
// DATE NAVIGATION
// =============================================
function shiftDay(d) {
  selectedDate = shiftDateStr(selectedDate, d);
  renderDaily();
}
function goToday() {
  selectedDate = todayStr();
  renderDaily();
}
function onDatePickerChange(v) {
  if (v) { selectedDate = v; renderDaily(); }
}

// =============================================
// TOAST
// =============================================
function toast(msg, icon = '‚úì') {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = 'toast';
  t.innerHTML = `<span>${icon}</span><span>${msg}</span>`;
  c.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

// =============================================
// TASK STATUS
// =============================================
function getTaskStatus(task, dateStr) {
  if (!task.intervals || task.intervals.length === 0) {
    // Unassigned
    if (isPast(dateStr)) return 'incomplete';
    return 'unassigned';
  }
  const minStart = Math.min(...task.intervals.map(i => parseMinutes(i.start)));
  const maxEnd = Math.max(...task.intervals.map(i => parseMinutes(i.end)));

  if (task.completed) return 'completed';

  if (isPast(dateStr)) return 'incomplete';
  if (isToday(dateStr)) {
    const now = nowMinutes();
    if (maxEnd < now) return 'incomplete'; // missed
    if (minStart > now) return 'upcoming';
    return 'ongoing';
  }
  return 'planned';
}

function statusBadge(status) {
  const map = {
    completed: ['badge-green', '‚úì Done'],
    incomplete: ['badge-red', '‚úï Missed'],
    upcoming: ['badge-blue', '‚è≥ Upcoming'],
    ongoing: ['badge-orange', '‚ö° Ongoing'],
    planned: ['badge-gray', 'üìÖ Planned'],
    unassigned: ['badge-accent', 'üìå Unassigned'],
  };
  const [cls, txt] = map[status] || ['badge-gray', status];
  return `<span class="badge ${cls}">${txt}</span>`;
}

// =============================================
// TIMER MANAGEMENT
// =============================================
function getTimerKey(dateStr, taskName) { return `${dateStr}|${taskName}`; }

function getElapsed(timer) {
  if (!timer) return 0;
  let acc = timer.accumulated_seconds || 0;
  if (timer.state === 'running' && timer.last_update) {
    acc += (Date.now() / 1000) - timer.last_update;
  }
  return Math.floor(acc);
}

function startTimer(dateStr, taskName) {
  const day = getOrCreateDay(dateStr);
  const task = day[taskName];
  if (!task) return;
  if (!task.timer) task.timer = { state: 'idle', accumulated_seconds: 0, last_update: null };
  task.timer.state = 'running';
  task.timer.last_update = Date.now() / 1000;
  saveData(appData);
  startTimerInterval(dateStr, taskName);
  renderTimerWidget(dateStr, taskName);
}

function pauseTimer(dateStr, taskName) {
  const task = getOrCreateDay(dateStr)[taskName];
  if (!task || !task.timer) return;
  const elapsed = getElapsed(task.timer);
  task.timer.accumulated_seconds = elapsed;
  task.timer.state = 'paused';
  task.timer.last_update = null;
  saveData(appData);
  stopTimerInterval(dateStr, taskName);
  renderTimerWidget(dateStr, taskName);
}

function stopTimer(dateStr, taskName) {
  const task = getOrCreateDay(dateStr)[taskName];
  if (!task || !task.timer) return;
  const elapsed = getElapsed(task.timer);
  task.timer.accumulated_seconds = elapsed;
  task.timer.state = 'stopped';
  task.timer.last_update = null;
  saveData(appData);
  stopTimerInterval(dateStr, taskName);
  renderTimerWidget(dateStr, taskName);
}

function resetTimer(dateStr, taskName) {
  const task = getOrCreateDay(dateStr)[taskName];
  if (!task || !task.timer) return;
  task.timer = { state: 'idle', accumulated_seconds: 0, last_update: null };
  saveData(appData);
  stopTimerInterval(dateStr, taskName);
  renderTimerWidget(dateStr, taskName);
}

function startTimerInterval(dateStr, taskName) {
  const key = getTimerKey(dateStr, taskName);
  if (runningTimers[key]) clearInterval(runningTimers[key]);
  runningTimers[key] = setInterval(() => {
    const task = getOrCreateDay(dateStr)[taskName];
    if (!task || !task.timer || task.timer.state !== 'running') {
      clearInterval(runningTimers[key]);
      delete runningTimers[key];
      return;
    }
    updateTimerDisplay(dateStr, taskName);
  }, 1000);
}

function stopTimerInterval(dateStr, taskName) {
  const key = getTimerKey(dateStr, taskName);
  if (runningTimers[key]) {
    clearInterval(runningTimers[key]);
    delete runningTimers[key];
  }
}

function updateTimerDisplay(dateStr, taskName) {
  const task = getOrCreateDay(dateStr)[taskName];
  if (!task || !task.timer) return;
  const el = document.getElementById(`timer-display-${CSS.escape(dateStr + '|' + taskName)}`);
  if (el) {
    el.textContent = formatTimer(getElapsed(task.timer));
  }
}

function renderTimerWidget(dateStr, taskName) {
  const task = getOrCreateDay(dateStr)[taskName];
  if (!task) return;
  const id = `timer-widget-${CSS.escape(dateStr + '|' + taskName)}`;
  const el = document.getElementById(id);
  if (!el) return;
  el.outerHTML = buildTimerWidget(dateStr, taskName, task.timer);
  // Re-start interval if running
  if (task.timer && task.timer.state === 'running') {
    startTimerInterval(dateStr, taskName);
  }
}

function buildTimerWidget(dateStr, taskName, timer) {
  const safeId = `${dateStr}|${taskName}`;
  const elapsed = getElapsed(timer);
  const state = timer ? timer.state : 'idle';
  const isDot = state === 'running';
  const dispClass = state === 'running' ? 'running' : state === 'paused' ? 'paused' : '';
  const dName = taskName.replace(/`/g, '\\`');
  const dDate = dateStr.replace(/`/g, '\\`');
  return `<div class="timer-widget" id="timer-widget-${CSS.escape(safeId)}">
    ${isDot ? '<div class="live-dot"></div>' : ''}
    <div class="timer-display ${dispClass}" id="timer-display-${CSS.escape(safeId)}">${formatTimer(elapsed)}</div>
    <div class="timer-buttons">
      ${state === 'idle' || state === 'stopped'
        ? `<button class="btn btn-green btn-sm" onclick="startTimer('${dDate}','${dName}')">‚ñ∂ Start</button>`
        : ''}
      ${state === 'running'
        ? `<button class="btn btn-ghost btn-sm" onclick="pauseTimer('${dDate}','${dName}')">‚è∏ Pause</button>
           <button class="btn btn-ghost btn-sm" onclick="stopTimer('${dDate}','${dName}')">‚èπ Stop</button>`
        : ''}
      ${state === 'paused'
        ? `<button class="btn btn-green btn-sm" onclick="startTimer('${dDate}','${dName}')">‚ñ∂ Resume</button>
           <button class="btn btn-ghost btn-sm" onclick="stopTimer('${dDate}','${dName}')">‚èπ Stop</button>`
        : ''}
      <button class="btn btn-ghost btn-sm" onclick="resetTimer('${dDate}','${dName}')">‚Ü∫</button>
    </div>
  </div>`;
}

// =============================================
// DAILY RENDER
// =============================================
function renderDaily() {
  // Date display
  document.getElementById('selectedDateDisplay').textContent = formatDateDisplay(selectedDate);
  document.getElementById('datePickerHidden').value = selectedDate;

  const day = appData.routines[selectedDate] || {};
  const tasks = Object.entries(day);
  const totalTasks = tasks.length;
  const completedTasks = tasks.filter(([,t]) => t.completed).length;
  const missedTasks = tasks.filter(([,t]) => getTaskStatus(t, selectedDate) === 'incomplete').length;
  const totalPlannedMin = tasks.reduce((sum, [,t]) => {
    return sum + (t.intervals || []).reduce((s, iv) => {
      const d = parseMinutes(iv.end) - parseMinutes(iv.start);
      return s + (d >= 0 ? d : 1440 + d);
    }, 0);
  }, 0);
  const totalTrackedSec = tasks.reduce((sum, [,t]) => sum + getElapsed(t.timer || {}), 0);
  const pct = totalTasks > 0 ? Math.round(completedTasks / totalTasks * 100) : 0;

  // Metrics
  document.getElementById('dailyMetrics').innerHTML = [
    { label: 'Tasks', value: totalTasks, sub: `${completedTasks} done` },
    { label: 'Completion', value: pct + '%', sub: missedTasks + ' missed', accent: pct > 70 },
    { label: 'Planned', value: formatDuration(totalPlannedMin), sub: 'scheduled' },
    { label: 'Tracked', value: formatTimer(totalTrackedSec).replace(/^00:/, ''), sub: 'time spent' },
  ].map(m => `<div class="metric-card">
    <div class="metric-label">${m.label}</div>
    <div class="metric-value" style="${m.accent ? 'color:var(--green)' : ''}">${m.value}</div>
    <div class="metric-sub">${m.sub}</div>
  </div>`).join('');

  // Progress bar in date bar
  document.getElementById('dayProgress').innerHTML = `
    <span style="margin-right:6px">${pct}% complete</span>
    <div style="display:inline-block;width:80px;height:4px;background:var(--surface3);border-radius:50px;vertical-align:middle">
      <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,var(--accent),var(--green));border-radius:50px;"></div>
    </div>`;

  renderTimeline(day);
  renderFilterRow(day);
  renderTaskList(day);

  // Auto-resume timers that were running when page closed
  Object.entries(day).forEach(([name, task]) => {
    if (task.timer && task.timer.state === 'running') {
      startTimerInterval(selectedDate, name);
    }
  });
}

// =============================================
// TIMELINE
// =============================================
function renderTimeline(day) {
  const track = document.getElementById('timelineTrack');
  const labels = document.getElementById('timelineLabels');

  // Hours 0-24 shown
  const hourStart = 6, hourEnd = 23;
  const totalMin = (hourEnd - hourStart) * 60;

  function pct(min) {
    return Math.max(0, Math.min(100, (min - hourStart * 60) / totalMin * 100));
  }

  let html = '';
  Object.entries(day).forEach(([name, task]) => {
    const color = catColor(task.category || 'Other');
    (task.intervals || []).forEach(iv => {
      const sm = parseMinutes(iv.start), em = parseMinutes(iv.end);
      const left = pct(sm);
      const width = pct(em) - left;
      if (width < 0.1) return;
      const status = getTaskStatus(task, selectedDate);
      const op = status === 'incomplete' ? '0.4' : '1';
      html += `<div class="timeline-block" style="left:${left}%;width:${Math.max(width,0.3)}%;background:${color}22;border:1px solid ${color}55;color:${color};opacity:${op}" title="${name}: ${iv.start}‚Äì${iv.end}">
        <span style="overflow:hidden;text-overflow:ellipsis">${name}</span>
      </div>`;
    });
  });

  // Now line
  if (isToday(selectedDate)) {
    const nowMin = nowMinutes();
    const nowPct = pct(nowMin);
    if (nowPct >= 0 && nowPct <= 100) {
      html += `<div class="timeline-now" style="left:${nowPct}%"></div>`;
    }
  }

  track.innerHTML = html || '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text3);font-size:.78rem;font-family:var(--font-mono)">No scheduled tasks</div>';

  // Labels
  let lhtml = '';
  for (let h = hourStart; h <= hourEnd; h += 2) {
    const lp = ((h - hourStart) / (hourEnd - hourStart)) * 100;
    lhtml += `<span style="position:absolute;left:${lp}%;transform:translateX(-50%)">${h}:00</span>`;
  }
  labels.style.position = 'relative';
  labels.innerHTML = lhtml;
}

// =============================================
// FILTER ROW
// =============================================
function renderFilterRow(day) {
  const cats = [...new Set(Object.values(day).map(t => t.category || 'Other'))];
  const filters = ['all', ...cats];
  document.getElementById('filterRow').innerHTML = filters.map(f => {
    const isSel = f === activeFilter;
    const col = f === 'all' ? 'var(--text2)' : catColor(f);
    return `<div class="chip ${isSel ? 'selected' : ''}" onclick="setFilter('${f}')" style="${isSel ? `background:${col}22;border-color:${col};color:${col}` : ''}">${f === 'all' ? 'All' : f}</div>`;
  }).join('');
}

function setFilter(f) {
  activeFilter = f;
  const day = appData.routines[selectedDate] || {};
  renderFilterRow(day);
  renderTaskList(day);
}

// =============================================
// TASK LIST
// =============================================
function renderTaskList(day) {
  const tasks = Object.entries(day);
  if (tasks.length === 0) {
    document.getElementById('taskList').innerHTML = `<div class="empty-state">
      <div class="empty-icon">‚ú¶</div>
      <div class="empty-msg">No tasks for this day</div>
      <div class="empty-sub">Press <strong>+ Task</strong> to add one</div>
    </div>`;
    return;
  }

  // Sort by: unassigned last, then by start time
  const sorted = tasks
    .filter(([, t]) => activeFilter === 'all' || t.category === activeFilter)
    .sort(([, a], [, b]) => {
      const aU = !a.intervals || a.intervals.length === 0;
      const bU = !b.intervals || b.intervals.length === 0;
      if (aU && !bU) return 1;
      if (!aU && bU) return -1;
      if (aU && bU) return 0;
      return parseMinutes(a.intervals[0].start) - parseMinutes(b.intervals[0].start);
    });

  if (sorted.length === 0) {
    document.getElementById('taskList').innerHTML = `<div class="empty-state"><div class="empty-msg">No tasks match filter</div></div>`;
    return;
  }

  document.getElementById('taskList').innerHTML = sorted.map(([name, task]) => buildTaskItem(name, task)).join('');

  // Re-start active timer intervals
  sorted.forEach(([name, task]) => {
    if (task.timer && task.timer.state === 'running') {
      startTimerInterval(selectedDate, name);
    }
  });
}

function buildTaskItem(name, task) {
  const status = getTaskStatus(task, selectedDate);
  const isUnassigned = status === 'unassigned';
  const isMissed = status === 'incomplete';
  const isDone = task.completed;
  const color = catColor(task.category || 'Other');
  const sName = name.replace(/'/g, "\\'");
  const sDate = selectedDate;
  const checkCls = isDone ? 'checked' : isMissed ? 'missed' : '';
  const checkIcon = isDone ? '‚úì' : isMissed ? '‚Äî' : '';
  const itemCls = isDone ? 'completed-task' : isMissed ? 'missed-task' : isUnassigned ? 'unassigned-task' : '';

  // Time display
  let timeDisplay = '';
  if (task.intervals && task.intervals.length > 0) {
    timeDisplay = task.intervals.map(iv => {
      const dur = parseMinutes(iv.end) - parseMinutes(iv.start);
      return `<span class="time-badge">${iv.start} <span class="arrow">‚Üí</span> ${iv.end} <span style="opacity:.5">¬∑</span> ${formatDuration(dur >= 0 ? dur : 1440 + dur)}</span>`;
    }).join('');
  } else {
    timeDisplay = '<span class="unassigned-tag">üìå No time assigned</span>';
  }

  // Intervals editor HTML
  const intervalsHTML = (task.intervals || []).map((iv, i) => `
    <div class="interval-row" id="ivrow-${CSS.escape(sDate+'|'+name+'|'+i)}">
      <div>
        <label>Start</label>
        <input type="time" value="${iv.start}" onchange="updateInterval('${sName}',${i},'start',this.value)"/>
      </div>
      <div>
        <label>End</label>
        <input type="time" value="${iv.end}" onchange="updateInterval('${sName}',${i},'end',this.value)"/>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn btn-danger btn-sm" onclick="removeInterval('${sName}',${i})">‚úï</button>
      </div>
      <div style="display:flex;align-items:flex-end">
        <span style="font-family:var(--font-mono);font-size:.75rem;color:var(--text3);white-space:nowrap">${formatDuration(Math.abs(parseMinutes(iv.end) - parseMinutes(iv.start)))}</span>
      </div>
    </div>
  `).join('');

  const timer = task.timer || { state: 'idle', accumulated_seconds: 0 };
  const timerHTML = buildTimerWidget(sDate, name, timer);

  return `<div class="task-item ${itemCls}" id="task-item-${CSS.escape(sDate+'|'+name)}">
    <div class="task-header" onclick="toggleTask('${sDate}','${sName}')">
      <div class="task-checkbox ${checkCls}" onclick="event.stopPropagation();toggleComplete('${sDate}','${sName}')">${checkIcon}</div>
      <div class="task-name ${isDone ? 'done' : ''}">${name}</div>
      <div class="task-meta">
        <span class="badge" style="background:${color}22;color:${color};border:1px solid ${color}44">${task.category || 'Other'}</span>
        ${statusBadge(status)}
        ${isUnassigned ? '' : ''}
      </div>
      <div style="color:var(--text3);font-size:.8rem;margin-left:4px">‚ñæ</div>
    </div>
    <div class="task-body" id="task-body-${CSS.escape(sDate+'|'+name)}">
      <div class="task-time-row">${timeDisplay}</div>

      <div style="margin-top:12px">
        <div class="section-header">
          <span class="section-title">Intervals</span>
          <button class="btn btn-ghost btn-sm" onclick="addInterval('${sName}')">+ Add Interval</button>
        </div>
        ${intervalsHTML}
        ${task.intervals && task.intervals.length === 0 ? '<p style="font-size:.78rem;color:var(--text3);font-family:var(--font-mono)">No intervals. Add one above.</p>' : ''}
      </div>

      ${timerHTML}

      <div style="margin-top:10px">
        <label>Notes</label>
        <textarea rows="2" placeholder="Add notes..." onchange="updateNotes('${sName}',this.value)">${task.notes || ''}</textarea>
      </div>

      <div class="divider"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-danger btn-sm" onclick="deleteTask('${sName}')">üóë Delete Task</button>
      </div>
    </div>
  </div>`;
}

function toggleTask(dateStr, name) {
  const body = document.getElementById(`task-body-${CSS.escape(dateStr+'|'+name)}`);
  if (body) body.classList.toggle('open');
}

function toggleComplete(dateStr, name) {
  const day = getOrCreateDay(dateStr);
  if (!day[name]) return;
  const status = getTaskStatus(day[name], dateStr);
  if (status === 'incomplete') return; // can't check missed
  day[name].completed = !day[name].completed;
  if (day[name].completed && !day[name].logged_on) {
    day[name].logged_on = new Date().toISOString();
  }
  saveData(appData);
  toast(day[name].completed ? `‚úì "${name}" marked done!` : `"${name}" unchecked`);
  renderDaily();
}

function deleteTask(name) {
  if (!confirm(`Delete "${name}"?`)) return;
  delete appData.routines[selectedDate][name];
  saveData(appData);
  toast(`üóë Deleted "${name}"`, 'üóë');
  renderDaily();
}

function updateInterval(name, idx, field, value) {
  const day = getOrCreateDay(selectedDate);
  if (!day[name] || !day[name].intervals[idx]) return;
  day[name].intervals[idx][field] = value;
  saveData(appData);
  renderDaily();
}

function addInterval(name) {
  const day = getOrCreateDay(selectedDate);
  if (!day[name]) return;
  const ivs = day[name].intervals || [];
  const lastEnd = ivs.length > 0 ? ivs[ivs.length - 1].end : '09:00';
  const endMin = parseMinutes(lastEnd) + 60;
  day[name].intervals.push({ start: lastEnd, end: minToTime(endMin % 1440) });
  saveData(appData);
  renderDaily();
  // Re-open
  setTimeout(() => {
    const body = document.getElementById(`task-body-${CSS.escape(selectedDate+'|'+name)}`);
    if (body) body.classList.add('open');
  }, 50);
}

function removeInterval(name, idx) {
  const day = getOrCreateDay(selectedDate);
  if (!day[name]) return;
  day[name].intervals.splice(idx, 1);
  saveData(appData);
  renderDaily();
  setTimeout(() => {
    const body = document.getElementById(`task-body-${CSS.escape(selectedDate+'|'+name)}`);
    if (body) body.classList.add('open');
  }, 50);
}

function updateNotes(name, val) {
  const day = getOrCreateDay(selectedDate);
  if (!day[name]) return;
  day[name].notes = val;
  saveData(appData);
}

// =============================================
// ADD MODAL
// =============================================
function openAddModal() {
  // Set smart default times
  const day = appData.routines[selectedDate] || {};
  const allEnds = Object.values(day).flatMap(t => (t.intervals || []).map(iv => parseMinutes(iv.end)));
  let defaultStart = allEnds.length > 0 ? Math.max(...allEnds) : (isToday(selectedDate) ? nowMinutes() : 9 * 60);
  if (isToday(selectedDate)) defaultStart = Math.max(defaultStart, nowMinutes());
  // Round up to 5 min
  defaultStart = Math.ceil(defaultStart / 5) * 5;
  document.getElementById('newTaskStart').value = minToTime(defaultStart % 1440);
  document.getElementById('newTaskEnd').value = minToTime((defaultStart + 60) % 1440);
  document.getElementById('newTaskName').value = '';
  document.getElementById('newTaskNotes').value = '';
  scheduleTypeMode = 'assign';
  renderCatPicker();
  renderScheduleTypePicker();
  document.getElementById('addModal').classList.add('open');
  setTimeout(() => document.getElementById('newTaskName').focus(), 100);
}

function closeAddModal() {
  document.getElementById('addModal').classList.remove('open');
}

function closeModalIfOverlay(e) {
  if (e.target === document.getElementById('addModal')) closeAddModal();
}

function renderCatPicker() {
  document.getElementById('catPicker').innerHTML = CATS.map(c => {
    const col = catColor(c);
    const isSel = c === selectedCat;
    return `<div class="chip ${isSel ? 'selected' : ''}" onclick="setCat('${c}')" style="${isSel ? `background:${col}22;border-color:${col};color:${col}` : ''}">${c}</div>`;
  }).join('');
}

function setCat(c) {
  selectedCat = c;
  renderCatPicker();
}

function setScheduleType(t) {
  scheduleTypeMode = t;
  renderScheduleTypePicker();
  document.getElementById('timeAssignSection').style.display = t === 'assign' ? 'block' : 'none';
}

function renderScheduleTypePicker() {
  document.getElementById('scheduleTypePicker').innerHTML = [
    { id: 'assign', label: 'Assign Time' },
    { id: 'later', label: 'Assign Later' },
  ].map(opt => {
    const isSel = opt.id === scheduleTypeMode;
    return `<div class="chip ${isSel ? 'selected' : ''}" data-sched="${opt.id}" onclick="setScheduleType('${opt.id}')">${opt.label}</div>`;
  }).join('');
}

function submitAddTask() {
  const name = document.getElementById('newTaskName').value.trim();
  if (!name) { toast('Please enter a task name', '‚ö†'); return; }
  const day = getOrCreateDay(selectedDate);
  if (day[name]) { toast(`"${name}" already exists`, '‚ö†'); return; }

  let intervals = [];
  if (scheduleTypeMode === 'assign') {
    const start = document.getElementById('newTaskStart').value;
    const end = document.getElementById('newTaskEnd').value;
    intervals = [{ start, end }];
  }

  day[name] = {
    completed: false,
    notes: document.getElementById('newTaskNotes').value,
    category: selectedCat,
    intervals,
    logged_on: null,
    timer: { state: 'idle', accumulated_seconds: 0, last_update: null }
  };

  saveData(appData);
  closeAddModal();
  toast(`Added "${name}"`, '‚ú¶');
  renderDaily();
}

// =============================================
// HABITS
// =============================================
const HABIT_COLORS = ['#7c6af7','#3ecf8e','#f7a35a','#5a9ef7','#f76a6a','#3ecff7','#b06af7','#f7d76a'];

function renderHabitColorPicker() {
  document.getElementById('habitColorPicker').innerHTML = HABIT_COLORS.map(c => {
    const isSel = c === habitSelectedColor;
    return `<div class="chip ${isSel ? 'selected' : ''}" onclick="setHabitColor('${c}')"
      style="background:${c}22;border-color:${isSel ? c : 'var(--border)'};color:${c}">
      <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${c};margin-right:4px;vertical-align:middle"></span>${c.slice(1)}
    </div>`;
  }).join('');
}

function setHabitColor(c) { habitSelectedColor = c; renderHabitColorPicker(); }

function addHabit() {
  const name = document.getElementById('habitNameInput').value.trim();
  if (!name) { toast('Enter habit name', '‚ö†'); return; }
  if (appData.habits[name]) { toast('Habit already exists', '‚ö†'); return; }
  const freq = document.getElementById('habitFreq').value;
  const target = freq === 'Custom (times per week)' ? parseInt(document.getElementById('habitTarget').value) : (freq === 'Daily' ? 1 : 1);
  appData.habits[name] = {
    frequency: freq, target, color: habitSelectedColor,
    completions: {}, notes: document.getElementById('habitNotes').value,
    created: todayStr()
  };
  saveData(appData);
  document.getElementById('habitNameInput').value = '';
  document.getElementById('habitNotes').value = '';
  toast(`Added habit "${name}"`, 'üî•');
  renderHabits();
}

document.getElementById('habitFreq').addEventListener('change', function() {
  document.getElementById('habitTargetRow').style.display = this.value.startsWith('Custom') ? 'block' : 'none';
});

function toggleHabitDay(name, dateStr) {
  const h = appData.habits[name];
  if (!h) return;
  h.completions[dateStr] = !h.completions[dateStr];
  saveData(appData);
  renderHabits();
}

function deleteHabit(name) {
  if (!confirm(`Delete habit "${name}"?`)) return;
  delete appData.habits[name];
  saveData(appData);
  renderHabits();
}

function calcStreak(habit) {
  const today = todayStr();
  let streak = 0, d = today;
  for (let i = 0; i < 365; i++) {
    if (habit.completions[d]) streak++;
    else if (d !== today) break;
    d = shiftDateStr(d, -1);
  }
  return streak;
}

function calcLongestStreak(habit) {
  const keys = Object.keys(habit.completions).filter(k => habit.completions[k]).sort();
  let longest = 0, current = 0, prev = null;
  for (const k of keys) {
    if (prev && shiftDateStr(prev, 1) === k) current++;
    else current = 1;
    if (current > longest) longest = current;
    prev = k;
  }
  return longest;
}

function renderHabits() {
  renderHabitColorPicker();
  const list = document.getElementById('habitList');
  const habits = appData.habits || {};
  if (Object.keys(habits).length === 0) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">üî•</div><div class="empty-msg">No habits yet</div><div class="empty-sub">Add your first habit</div></div>`;
    return;
  }

  const today = todayStr();
  // Last 30 days for heatmap
  const last30 = Array.from({length: 30}, (_, i) => shiftDateStr(today, -29 + i));

  list.innerHTML = Object.entries(habits).map(([name, h]) => {
    const streak = calcStreak(h);
    const longest = calcLongestStreak(h);
    const donedToday = h.completions[today];
    const col = h.color || '#7c6af7';

    const heatCells = last30.map(d => {
      const v = h.completions[d] ? 3 : 0;
      return `<div class="heatmap-cell" data-val="${v}" style="${v > 0 ? `background:${col}${['','55','99','ff'][v]}` : ''}" title="${d}"></div>`;
    }).join('');

    return `<div class="card" style="margin-bottom:1rem;border-left:3px solid ${col}">
      <div style="display:flex;align-items:start;gap:12px;margin-bottom:10px">
        <div style="flex:1">
          <div style="font-weight:800;font-size:1rem">${name}</div>
          <div style="font-size:.75rem;color:var(--text3);font-family:var(--font-mono);margin-top:2px">${h.frequency}${h.notes ? ' ¬∑ ' + h.notes : ''}</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <button class="btn btn-sm ${donedToday ? 'btn-green' : 'btn-ghost'}" onclick="toggleHabitDay('${name}','${today}')">
            ${donedToday ? '‚úì Done Today' : '‚óã Mark Today'}
          </button>
          <button class="btn btn-danger btn-sm" onclick="deleteHabit('${name}')">üóë</button>
        </div>
      </div>

      <div style="display:flex;gap:20px;margin-bottom:10px">
        <div class="streak-row"><span class="streak-num">${streak}</span> <span>day streak</span> ${streak > 0 ? 'üî•' : ''}</div>
        <div class="streak-row" style="color:var(--text3)">Longest: <span class="streak-num" style="color:var(--text2)">${longest}</span></div>
      </div>

      <div style="font-size:.68rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text3);margin-bottom:4px">Last 30 days</div>
      <div class="heatmap-grid">${heatCells}</div>
    </div>`;
  }).join('');
}

// =============================================
// WEEKLY
// =============================================
function renderWeekly() {
  const today = new Date(todayStr() + 'T00:00:00');
  const mon = new Date(today);
  mon.setDate(today.getDate() - ((today.getDay() + 6) % 7));

  const days = Array.from({length: 7}, (_, i) => {
    const d = new Date(mon);
    d.setDate(mon.getDate() + i);
    return d.toISOString().slice(0, 10);
  });

  const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

  document.getElementById('weekGrid').innerHTML = days.map((d, i) => {
    const routine = appData.routines[d] || {};
    const tasks = Object.values(routine);
    const total = tasks.length;
    const done = tasks.filter(t => t.completed).length;
    const pct = total > 0 ? done / total : 0;
    const isT = d === todayStr();
    return `<div class="week-cell ${isT ? 'today' : ''}" onclick="goToDate('${d}')" style="cursor:pointer">
      <div class="week-day">${dayNames[i]}</div>
      <div class="week-date">${new Date(d + 'T00:00:00').getDate()}</div>
      <div style="font-family:var(--font-mono);font-size:.7rem;color:var(--text3)">${done}/${total}</div>
      <div class="week-bar"><div class="week-bar-fill" style="width:${pct*100}%"></div></div>
    </div>`;
  }).join('');

  // Chart
  const labels = days.map(d => new Date(d + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short' }));
  const planned = days.map(d => {
    const r = appData.routines[d] || {};
    return Object.values(r).reduce((s, t) => s + (t.intervals || []).reduce((ss, iv) => {
      const dur = parseMinutes(iv.end) - parseMinutes(iv.start);
      return ss + (dur >= 0 ? dur : 1440 + dur);
    }, 0), 0) / 60;
  });
  const tracked = days.map(d => {
    const r = appData.routines[d] || {};
    return Object.values(r).reduce((s, t) => s + getElapsed(t.timer || {}), 0) / 3600;
  });

  if (weeklyChartInst) weeklyChartInst.destroy();
  weeklyChartInst = new Chart(document.getElementById('weeklyChart'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Planned Hours', data: planned, backgroundColor: 'rgba(90,158,247,0.5)', borderColor: '#5a9ef7', borderWidth: 1, borderRadius: 6 },
        { label: 'Tracked Hours', data: tracked, backgroundColor: 'rgba(62,207,142,0.5)', borderColor: '#3ecf8e', borderWidth: 1, borderRadius: 6 },
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: '#9198b0', font: { family: 'Syne' } } } },
      scales: {
        x: { ticks: { color: '#5a617a' }, grid: { color: '#1e2130' } },
        y: { ticks: { color: '#5a617a' }, grid: { color: '#1e2130' } }
      }
    }
  });

  // Weekly details table
  document.getElementById('weeklyDetails').innerHTML = `<div class="card">
    <table style="width:100%;border-collapse:collapse;font-size:.82rem">
      <thead>
        <tr style="color:var(--text3);font-size:.7rem;text-transform:uppercase;letter-spacing:.08em">
          <th style="text-align:left;padding:.5rem .8rem;font-weight:700">Date</th>
          <th style="padding:.5rem;font-weight:700">Tasks</th>
          <th style="padding:.5rem;font-weight:700">Done</th>
          <th style="padding:.5rem;font-weight:700">Planned</th>
          <th style="padding:.5rem;font-weight:700">Tracked</th>
          <th style="padding:.5rem;font-weight:700">Rate</th>
        </tr>
      </thead>
      <tbody>
        ${days.map((d, i) => {
          const r = appData.routines[d] || {};
          const tvs = Object.values(r);
          const tot = tvs.length;
          const dn = tvs.filter(t => t.completed).length;
          const rate = tot > 0 ? Math.round(dn / tot * 100) : 0;
          const isT = d === todayStr();
          return `<tr style="border-top:1px solid var(--border)${isT ? ';background:var(--surface2)' : ''}">
            <td style="padding:.6rem .8rem;font-weight:700">${dayNames[i]} ${new Date(d+'T00:00:00').getDate()} ${isT ? '<span class="badge badge-accent">Today</span>' : ''}</td>
            <td style="text-align:center;padding:.6rem">${tot}</td>
            <td style="text-align:center;padding:.6rem">${dn}</td>
            <td style="text-align:center;padding:.6rem;font-family:var(--font-mono)">${planned[i].toFixed(1)}h</td>
            <td style="text-align:center;padding:.6rem;font-family:var(--font-mono)">${tracked[i].toFixed(2)}h</td>
            <td style="text-align:center;padding:.6rem">
              <div style="display:flex;align-items:center;gap:6px;justify-content:center">
                <div style="width:50px;height:4px;background:var(--surface3);border-radius:50px">
                  <div style="width:${rate}%;height:100%;background:var(--accent);border-radius:50px"></div>
                </div>
                <span style="font-family:var(--font-mono);font-size:.72rem;color:var(--text2)">${rate}%</span>
              </div>
            </td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>
  </div>`;
}

function goToDate(d) {
  selectedDate = d;
  switchTab('daily');
  renderDaily();
}

// =============================================
// ANALYTICS
// =============================================
function renderAnalytics() {
  const all = [];
  Object.entries(appData.routines).forEach(([d, routine]) => {
    Object.entries(routine).forEach(([name, task]) => {
      all.push({
        date: d, name,
        category: task.category || 'Other',
        completed: task.completed,
        trackedHours: getElapsed(task.timer || {}) / 3600,
        plannedMin: (task.intervals || []).reduce((s, iv) => {
          const dur = parseMinutes(iv.end) - parseMinutes(iv.start);
          return s + (dur >= 0 ? dur : 1440 + dur);
        }, 0)
      });
    });
  });

  const totalTasks = all.length;
  const completedAll = all.filter(t => t.completed).length;
  const totalTracked = all.reduce((s, t) => s + t.trackedHours, 0);
  const compRate = totalTasks > 0 ? Math.round(completedAll / totalTasks * 100) : 0;

  document.getElementById('analyticsMetrics').innerHTML = [
    { label: 'Total Tasks', value: totalTasks },
    { label: 'Completion Rate', value: compRate + '%', accent: compRate > 70 },
    { label: 'Total Tracked', value: totalTracked.toFixed(1) + 'h' },
  ].map(m => `<div class="metric-card">
    <div class="metric-label">${m.label}</div>
    <div class="metric-value" style="${m.accent ? 'color:var(--green)' : ''}">${m.value}</div>
  </div>`).join('');

  // Category pie
  const catData = {};
  all.forEach(t => { catData[t.category] = (catData[t.category] || 0) + t.trackedHours; });
  const catLabels = Object.keys(catData);
  const catVals = catLabels.map(c => catData[c]);
  const catCols = catLabels.map(c => catColor(c));

  if (catChartInst) catChartInst.destroy();
  catChartInst = new Chart(document.getElementById('catChart'), {
    type: 'doughnut',
    data: { labels: catLabels, datasets: [{ data: catVals, backgroundColor: catCols.map(c => c + '99'), borderColor: catCols, borderWidth: 2 }] },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: '#9198b0', font: { family: 'Syne' } } }
      }
    }
  });

  // Daily trend
  const dateMap = {};
  all.forEach(t => { dateMap[t.date] = (dateMap[t.date] || 0) + t.trackedHours; });
  const sortedDates = Object.keys(dateMap).sort();

  if (trendChartInst) trendChartInst.destroy();
  trendChartInst = new Chart(document.getElementById('trendChart'), {
    type: 'line',
    data: {
      labels: sortedDates.map(d => new Date(d + 'T00:00:00').toLocaleDateString('en-US', { month:'short', day:'numeric' })),
      datasets: [{
        label: 'Tracked Hours',
        data: sortedDates.map(d => dateMap[d]),
        borderColor: '#7c6af7', backgroundColor: 'rgba(124,106,247,0.1)',
        fill: true, tension: 0.4, pointBackgroundColor: '#7c6af7'
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: '#9198b0', font: { family: 'Syne' } } } },
      scales: {
        x: { ticks: { color: '#5a617a' }, grid: { color: '#1e2130' } },
        y: { ticks: { color: '#5a617a' }, grid: { color: '#1e2130' } }
      }
    }
  });

  // Completion rate trend
  const compMap = {};
  all.forEach(t => {
    if (!compMap[t.date]) compMap[t.date] = { done: 0, total: 0 };
    compMap[t.date].total++;
    if (t.completed) compMap[t.date].done++;
  });
  const compDates = Object.keys(compMap).sort();

  if (completionChartInst) completionChartInst.destroy();
  completionChartInst = new Chart(document.getElementById('completionChart'), {
    type: 'bar',
    data: {
      labels: compDates.map(d => new Date(d + 'T00:00:00').toLocaleDateString('en-US', { month:'short', day:'numeric' })),
      datasets: [{
        label: 'Completion %',
        data: compDates.map(d => Math.round(compMap[d].done / compMap[d].total * 100)),
        backgroundColor: compDates.map(d => {
          const r = Math.round(compMap[d].done / compMap[d].total * 100);
          return r >= 70 ? 'rgba(62,207,142,0.5)' : r >= 40 ? 'rgba(247,163,90,0.5)' : 'rgba(247,106,106,0.5)';
        }),
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: '#9198b0', font: { family: 'Syne' } } } },
      scales: {
        x: { ticks: { color: '#5a617a' }, grid: { color: '#1e2130' } },
        y: { min: 0, max: 100, ticks: { color: '#5a617a', callback: v => v + '%' }, grid: { color: '#1e2130' } }
      }
    }
  });
}

// =============================================
// INIT
// =============================================

// =============================================
// DATA PANEL
// =============================================
function openDataPanel() {
  // Update file status text inside modal
  const statusEl = document.getElementById('dataModalFileStatus');
  if (statusEl) {
    if (_fileHandle) {
      statusEl.innerHTML = '<span style="color:var(--green)">‚óè Linked to: ' + _fileHandle.name + '</span>';
    } else {
      statusEl.innerHTML = '<span style="color:var(--text3)">Not linked to any file yet.</span>';
    }
  }
  // Storage stats
  const statsEl = document.getElementById('storageStats');
  if (statsEl) {
    const raw = localStorage.getItem('tempo_v2') || '{}';
    const sizeKb = (new Blob([raw]).size / 1024).toFixed(1);
    const days = Object.keys(appData.routines || {}).length;
    const habits = Object.keys(appData.habits || {}).length;
    const tasks = Object.values(appData.routines || {}).reduce((s, d) => s + Object.keys(d).length, 0);
    statsEl.innerHTML =
      'Days tracked: ' + days + '<br>' +
      'Total tasks: ' + tasks + '<br>' +
      'Habits: ' + habits + '<br>' +
      'localStorage size: ' + sizeKb + ' KB<br>' +
      'File linked: ' + (_fileHandle ? _fileHandle.name : 'None');
  }
  document.getElementById('dataModal').classList.add('open');
}

function closeDataPanel() {
  document.getElementById('dataModal').classList.remove('open');
}

function closeDataPanelIfOverlay(e) {
  if (e.target === document.getElementById('dataModal')) closeDataPanel();
}

function clearAllData() {
  if (!confirm('DELETE all local data? This cannot be undone. (Your linked file, if any, is safe.)')) return;
  localStorage.removeItem('tempo_v2');
  appData = { routines: {}, habits: {} };
  closeDataPanel();
  toast('Local data cleared', 'üóë');
  renderDaily();
}

function init() {
  renderCatPicker();
  renderScheduleTypePicker();
  renderHabitColorPicker();
  renderDaily();
  // Try to restore previously linked file handle (if browser still has permission)
  tryRestoreFileHandle();
  // Update timeline now-line every minute
  setInterval(() => {
    if (document.getElementById('page-daily').classList.contains('active') && isToday(selectedDate)) {
      const day = appData.routines[selectedDate] || {};
      renderTimeline(day);
    }
  }, 60000);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
